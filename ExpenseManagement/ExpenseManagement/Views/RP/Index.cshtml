@model ExpenseManagement.Models.RegularPaymentsViewModel

@{
	ViewData["Title"] = "Regular Payments";
	Layout = "_DashboardSideNav";
}

<h1>Regular Payments</h1>
<div class="row">
	<div class="col-md-6 mb-2">
		<div class="div-card">
			<h3>
				Expenses
			</h3>
			<button type="button" class="btn btn-success btn-sm mb-2" data-bs-toggle="modal" data-bs-target="#addRPModal" data-type="Expense">
				<i class="bi bi-plus"></i> Add
			</button>
			<table class="table table-dark table-striped">
				<thead>
					<tr>
						<th>Name</th>
						<th>Amount</th>
						<th>Recurrence Day</th>
						<th>Category</th>
						<th>Note</th>
						<th>Actions</th>
					</tr>
				</thead>
				<tbody>
					@foreach (var rp in Model.ExpenseRPs)
					{
						<tr>
							<td>@rp.Name</td>
							<td>@rp.Amount</td>
							<td>@rp.RecurrenceDay °</td>
							<td>@rp.CategoryName</td>
							<td>@rp.Note</td>
							<td>
								<button type="button" class="btn btn-primary btn-sm" data-id="@rp.Id" data-bs-toggle="modal" data-bs-target="#editRPModal" >
									<i class="bi bi-pencil"></i> Edit
								</button>
								<button type="button" class="btn btn-danger btn-sm" data-id="@rp.Id" data-bs-toggle="modal" data-bs-target="#deleteRPModal" >
									<i class="bi bi-trash"></i> Delete
								</button>
							</td>
						</tr>
					}
				</tbody>
			</table>
		</div>
    </div>
	<div class="col-md-6 mb-2">
		<div class="div-card">
			<h3>
				Income
			</h3>
			<button type="button" class="btn btn-success btn-sm mb-2" data-bs-toggle="modal" data-bs-target="#addRPModal" data-type="Income">
				<i class="bi bi-plus"></i> Add
			</button>
			<table class="table table-dark table-striped">
				<thead>
					<tr>
						<th>Name</th>
						<th>Amount</th>
						<th>Recurrence Day</th>
						<th>Category</th>
						<th>Note</th>
						<th>Actions</th>
					</tr>
				</thead>
				<tbody>
					@foreach (var rp in Model.IncomeRPs)
					{
						<tr>
							<td>@rp.Name</td>
							<td>@rp.Amount</td>
							<td>@rp.RecurrenceDay °</td>
							<td>@rp.CategoryName</td>
							<td>@rp.Note</td>
							<td>
								<button type="button" class="btn btn-primary btn-sm" data-id="@rp.Id" data-bs-toggle="modal" data-bs-target="#editRPModal" >
									<i class="bi bi-pencil"></i> Edit
								</button>
								<button type="button" class="btn btn-danger btn-sm" data-id="@rp.Id" data-bs-toggle="modal" data-bs-target="#deleteRPModal" >
									<i class="bi bi-trash"></i> Delete
								</button>
							</td>
						</tr>
					}
				</tbody>
			</table>
		</div>
    </div>
</div>

<div>
	@await Html.PartialAsync("_AddRPModal", new AddRegularPaymentModel())
	@await Html.PartialAsync("_EditRPModal", new EditRegularPaymentModel())
	@await Html.PartialAsync("_DeleteRPModal", new DeleteModel())
</div>

@section Scripts {
	<script>
		$(document).ready(function () {
			$('#addRPModal').on('show.bs.modal', function (event) {
				var button = $(event.relatedTarget);
				var type = button.data('type');
				var modal = $(this);

				modal.find('#RPType').val(type);

				var categorySelect = $('#addRPCategory');
				var categories = type === 'Income'
					? @Html.Raw(Json.Serialize(ViewBag.IncomeCategories))
					: @Html.Raw(Json.Serialize(ViewBag.ExpenseCategories));

				categorySelect.empty();
				var defaultOption = document.createElement('option');
				defaultOption.value = '';
				defaultOption.text = 'Select a category';
				defaultOption.disabled = true;
				defaultOption.selected = true;
				categorySelect.append(defaultOption);

				$.each(categories, function (index, category) {
					var option = document.createElement('option');
					option.value = category.id;
					option.text = category.name;
					categorySelect.append(option);
				});
			});

			$('#submitRP').click(function () {
				$('#addRPForm').submit();
			});

			$('#deleteRPModal').on('show.bs.modal', function (event) {
				var button = $(event.relatedTarget);
				var id = button.data('id');
				var modal = $(this);

				modal.find('#deleteRPId').val(id);
			});

			$('#confirmDeleteRP').click(function () {
				$('#deleteRPForm').submit();
			});

			$('#editRPModal').on('show.bs.modal', function (event) {
				var button = $(event.relatedTarget);
				var id = button.data('id');

				$.ajax({
					url: '/RP/GetRP',
					type: 'GET',
					data: { id: id },
					success: function (data) {
						var modal = $('#editRPModal');

						modal.find('#editRPID').val(data.id);
						modal.find('#editRPType').val(data.type);
						modal.find('#editRPName').val(data.name);
						modal.find('#editRPAmount').val(data.amount);
						modal.find('#editRPCategory').val(data.categoryId);
						modal.find('#editRPRecurrenceDay').val(data.recurrenceDay);
						modal.find('#editRPNote').val(data.note);

						var categories = data.type === 'Expense'
							? @Html.Raw(Json.Serialize(ViewBag.ExpenseCategories))
							: @Html.Raw(Json.Serialize(ViewBag.IncomeCategories));

						var categorySelect = modal.find('#editRPCategory');

						categorySelect.empty();
						$.each(categories, function (index, category) {
							var option = document.createElement('option');
							option.value = category.id;
							option.text = category.name;
							categorySelect.append(option);
						});
						categorySelect.val(data.categoryId);
					}
				});
			});

			$('#submitEditRP').click(function () {
				$('#editRPForm').submit();
			});
		});
	</script>
}
